<div class="challenge-detail-page">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-state">
    <div class="skeleton-header">
      <div class="skeleton-title"></div>
      <div class="skeleton-subtitle"></div>
      <div class="skeleton-actions"></div>
    </div>
    <div class="skeleton-grid">
      <div class="skeleton-row" *ngFor="let i of [1,2,3,4,5]">
        <div class="skeleton-cell" *ngFor="let j of [1,2,3,4,5]"></div>
      </div>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-state">
    <div class="error-content">
      <h3>Unable to load challenge</h3>
      <p>{{ error }}</p>
      <button class="btn btn-primary" (click)="loadChallenge()">Try Again</button>
      <button class="btn btn-secondary" routerLink="/metrics-app/challenges">Back to Challenges</button>
    </div>
  </div>

  <!-- Challenge Detail Content -->
  <div *ngIf="!isLoading && !error && challenge" class="challenge-content">
    <!-- Challenge Header -->
    <div class="challenge-header">
      <div class="challenge-info">
        <div class="challenge-title-section">
          <h1 class="challenge-name">
            <span class="challenge-icon">üéØ</span>
            {{ challenge.name }}
          </h1>
          <div class="challenge-meta">
            <span class="date-range">
              <span class="meta-icon">üìÖ</span>
              {{ formatDate(challenge.startDate) }} - {{ formatDate(challenge.endDate) }}
            </span>
          </div>
        </div>
        <div class="challenge-status-section">
          <!-- Progress Bar -->
          <div class="progress-section">
            <div class="progress-info">
              <span class="progress-label">Challenge Progress</span>
              <span class="progress-text">{{ getCompletionProgress().completed }} of {{ getCompletionProgress().total }}
                days elapsed</span>
            </div>
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getCompletionProgress().percentage">
                </div>
              </div>
              <span class="progress-percentage">{{ getCompletionProgress().percentage }}%</span>
            </div>
          </div>
        </div>
      </div>
      <div class="challenge-actions">
        <button class="btn btn-primary btn-sm" (click)="showModifyChallengeDialog()">
          <span class="btn-icon">‚úèÔ∏è</span>
          Modify Challenge
        </button>
        <button class="btn btn-outline btn-sm" routerLink="/metrics-app/challenges">
          <span class="btn-icon">‚Üê</span>
          Back to Challenges
        </button>
        <button class="btn btn-info btn-sm" (click)="analyzeChallenge()" [disabled]="isAnalyzing">
          <span class="btn-icon" *ngIf="!isAnalyzing">ü§ñ</span>
          <span *ngIf="isAnalyzing">Analyzing...</span>
          <span *ngIf="!isAnalyzing">AI Analysis</span>
        </button>
      </div>
    </div>


    <!-- Challenge Grid -->
    <div class="challenge-grid-container">
      <div class="grid-header">
        <div class="grid-cell date-header">Date</div>
        <div *ngFor="let habit of habits" class="grid-cell habit-header" [title]="habit.habitDescription">
          {{ habit.habitName }}
        </div>
        <div class="grid-cell notes-header">Notes</div>
      </div>

      <div class="grid-body">
        <div *ngFor="let date of dates; trackBy: trackByDate" class="grid-row">
          <div class="grid-cell date-cell">
            <div class="date-info">
              <span class="day-of-week">{{ date.dayOfWeek }}</span>
              <span class="formatted-date">{{ date.formattedDate }}</span>
            </div>
          </div>

          <div *ngFor="let habit of habits; trackBy: trackByHabitId" class="grid-cell habit-cell"
            [class.clickable]="!date.isFuture" [class.disabled]="date.isFuture"
            (click)="onHabitCellClick(habit.habitId, date.date)" [title]="getCellTooltip(habit.habitId, date.date)">
            <app-status-icon [status]="getCellStatus(habit.habitId, date.date)">
            </app-status-icon>
          </div>

          <div class="grid-cell notes-cell" [class.clickable]="!date.isFuture" [class.disabled]="date.isFuture"
            (click)="onNotesCellClick(date.date)" [title]="getNotesTooltip(date.date)">
            <div class="notes-preview">
              {{ getNotesPreview(date.date) }}
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Notes Dialog -->
  <app-note-dialog [date]="selectedNoteDate" [isVisible]="showNoteDialog" [initialNote]="selectedNoteText"
    (close)="onNoteDialogClose()" (save)="onNoteDialogSave($event)">
  </app-note-dialog>

  <!-- Habit Confirmation Dialog -->
  <app-habit-confirmation [isVisible]="showHabitConfirmation" [habitName]="confirmationHabitName"
    [date]="confirmationDate" (confirm)="onHabitConfirmationConfirm()" (cancel)="onHabitConfirmationCancel()"
    (close)="closeHabitConfirmation()">
  </app-habit-confirmation>

  <!-- Confirmation Dialog -->
  <app-confirmation-dialog [isVisible]="showConfirmationDialog" [data]="confirmationDialogData"
    [isLoading]="isRemovingHabit" (confirm)="onConfirmationDialogConfirm()" (cancel)="onConfirmationDialogCancel()"
    (close)="onConfirmationDialogClose()">
  </app-confirmation-dialog>

  <!-- Habit Management Dialog -->
  <div *ngIf="showHabitSelectionDialog" class="modal-overlay" (click)="closeHabitSelectionDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <h3>Modify Challenge</h3>
          <p class="modal-subtitle">Update challenge details and manage habits for "{{ challenge?.name }}"</p>
        </div>
        <button class="close-btn" (click)="closeHabitSelectionDialog()">
          <span class="close-icon">√ó</span>
        </button>
      </div>

      <div class="modal-body">
        <!-- Challenge Update Form -->
        <div class="challenge-update-section">
          <h4>Challenge Details</h4>
          <form [formGroup]="challengeUpdateForm" class="challenge-update-form">
            <div class="form-group">
              <label for="challengeName">Challenge Name</label>
              <input type="text" id="challengeName" formControlName="name" class="form-input"
                placeholder="Enter challenge name">
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="startDate">Start Date</label>
                <input type="date" id="startDate" formControlName="startDate" class="form-input">
              </div>

              <div class="form-group">
                <label for="durationDays">Duration (Days)</label>
                <input type="number" id="durationDays" formControlName="durationDays" class="form-input" min="1"
                  placeholder="Enter duration in days">
              </div>
            </div>
          </form>
        </div>

        <!-- Current Habits Section -->
        <div class="current-habits-section">
          <h4>Current Habits</h4>
          <div class="current-habits-list" *ngIf="getCurrentHabitsCount() > 0">
            <div *ngFor="let habit of challenge?.habitsInfo || []" class="current-habit-item">
              <div class="habit-info">
                <span class="habit-name">{{ habit.habitName }}</span>
                <span class="habit-description" *ngIf="habit.habitDescription">{{ habit.habitDescription }}</span>
              </div>
              <button class="btn btn-danger btn-sm" (click)="removeHabit(habit.habitId, habit.habitName)"
                [disabled]="isRemovingHabit">
                <span class="btn-icon">üóë</span>
                Remove
              </button>
            </div>
          </div>
          <div class="no-current-habits" *ngIf="getCurrentHabitsCount() === 0">
            <span class="empty-icon">üìù</span>
            <p>No habits in this challenge yet</p>
          </div>
        </div>

        <!-- Add Habits Section -->
        <div class="add-habits-section">
          <h4>Add New Habits</h4>
          <div *ngIf="availableHabits.length === 0" class="no-available-habits">
            <span class="empty-icon">üìù</span>
            <p>No available habits to add. <a routerLink="/metrics-app/habits">Create a new habit</a> first.</p>
          </div>
          <div *ngIf="availableHabits.length > 0" class="available-habits-list">
            <div *ngFor="let habit of availableHabits" class="available-habit-item">
              <label class="habit-checkbox">
                <input type="checkbox" [value]="habit.habitId" (change)="toggleHabitSelection(habit.habitId, $event)"
                  [disabled]="isUpdatingChallenge">
                <div class="habit-content">
                  <span class="habit-name">{{ habit.name }}</span>
                  <span class="habit-description" *ngIf="habit.description">{{ habit.description }}</span>
                </div>
              </label>
            </div>
          </div>
        </div>

      </div>

      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeHabitSelectionDialog()" [disabled]="isUpdatingChallenge">
          Cancel
        </button>
        <button class="btn btn-primary" (click)="updateChallenge()"
          [disabled]="challengeUpdateForm.invalid || isUpdatingChallenge">
          <span class="btn-icon" *ngIf="!isUpdatingChallenge">üíæ</span>
          <span *ngIf="isUpdatingChallenge">Saving...</span>
          <span *ngIf="!isUpdatingChallenge">Save</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Analysis Result Dialog -->
  <div *ngIf="showAnalysisDialog" class="modal-overlay" (click)="closeAnalysisDialog()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-title">
          <h3>Challenge Analysis</h3>
        </div>
        <button class="close-btn" (click)="closeAnalysisDialog()">
          <span class="close-icon">√ó</span>
        </button>
      </div>
      <div class="modal-body">
        <markdown class="analysis-text" [data]="analysisResult"></markdown>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" (click)="closeAnalysisDialog()">Close</button>
      </div>
    </div>
  </div>
</div>